#!/usr/bin/env ruby
require('httparty')

base_uri = '<%= @node['check_mk']['notifications']['nawom']['url'] %>'
base_uri << '/' << <%= @node['check_mk']['notifications']['nawom']['api_version'] %> << '/event/'

# pattern: HOSTSTATE|SERVICESTATE:SERVICECHECK@HOST.ENVIRONMENT#PID&PID
host_state = ENV['NOTIFY_HOSTSTATE']
service_state = ENV['NOTIFY_SERVICESTATE']
service_check = ENV['NOTIFY_SERVICECHECKCOMMAND']
host = ENV['NOTIFY_HOSTNAME']
hosttags = ENV['NOTIFY_HOSTTAGS']
environment = ''
pids = hosttags

event = host_state + '|' + service_state + ':' + service_check + '@' + host + '.' + environment + '#' + pids

ex_event = {:name => event, :occured_at => Time.now.getutc.to_i, :message => ''}
ex_event = JSON.generate(ex_event)

options = { :body => { :event => ex_event } }

HTTParty.post(base_uri, options)