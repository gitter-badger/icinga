#!/usr/bin/env ruby
require('httparty')

base_uri = '<%= @node['check_mk']['notifications']['nawom']['url'] %>'
base_uri << '/' << '<%= @node['check_mk']['notifications']['nawom']['api_version'] %>' << '/event/'

# pattern: HOSTSTATE|SERVICESTATE:SERVICECHECK@HOST.ENVIRONMENT#PID&PID
host_state = ENV['NOTIFY_HOSTSTATE'].to_s
service_state = ENV['NOTIFY_SERVICESTATE'].to_s
service_check = ENV['NOTIFY_SERVICECHECKCOMMAND'].to_s
host = ENV['NOTIFY_HOSTNAME'].to_s
hosttags = ENV['NOTIFY_HOSTTAGS'].to_s
hosttags = hosttags.split(" ")

pids = []
hosttags.each do |hosttag|
  pids.push(hosttag) if hosttag.to_s == hosttag.to_i.to_s
end

environment = 'UNKNOWN'
environment = hosttags[4] unless hosttags.empty?

notify_message = ''
notify_message = message + ENV['NOTIFY_HOSTOUTPUT'].to_s + '\r\n' + ENV['NOTIFY_SERVICEOUTPUT'].to_s

notify_event = ''
notify_event = host_state + '|' + service_state + ':' + service_check + '@' + host + '.' + environment + '#' + pids.join('&')

ex_event = {:name => notify_event, :occured_at => Time.now.getutc.to_i, :message => notify_message}
ex_event = JSON.generate(ex_event)

options = { :body => { :event => ex_event } }

HTTParty.post(base_uri, options)